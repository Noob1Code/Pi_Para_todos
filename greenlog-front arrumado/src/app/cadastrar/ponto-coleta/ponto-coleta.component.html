<app-modal-bairros 
  [visivel]="modalBairrosVisivel"
  (fechado)="fecharModalBairros()"
  (bairroSelecionado)="onBairroSelecionado($event)"
  [filtro]="centro">
</app-modal-bairros>

<div class="form-container">

  <header>
    <h2>{{ idEditando ? 'Editar' : 'Cadastro de' }} Ponto De Coleta</h2>
  </header>

  <form (ngSubmit)="salvar(formPontoColeta)" #formPontoColeta="ngForm">
    
    <div class="form-group">
      <label for="bairro">Bairro:</label>
      <input 
        id="bairro"
        name="bairro" 
        type="text"
        [(ngModel)]="pontoColetaAtual.bairro.nome"
        placeholder="Clique aqui para selecionar o bairro"
        readonly
        #bairroInput="ngModel"
        (click)="abrirModalBairros()"
        required
        [ngClass]="{ 'invalid-input': bairroInput.invalid && (bairroInput.dirty || bairroInput.touched) }"
      />
      <div *ngIf="bairroInput.invalid && (bairroInput.dirty || bairroInput.touched)" class="error-message">
        <small *ngIf="bairroInput.errors?.['required']">Bairro do ponto √© obrigat√≥rio.</small>
      </div>
    </div>

    <div class="form-group">
      <label for="nome">Nome do Ponto:</label>
      <input 
        id="nome" 
        name="nome" 
        [(ngModel)]="pontoColetaAtual.nome" 
        type="text" 
        placeholder="Ex: Centro Comunit√°rio"
        required
        minlength="3"
        pattern="^[A-Za-z0-9√Ä-√ø\s]+$"
        #nomeInput="ngModel"
        [ngClass]="{ 'invalid-input': nomeInput.invalid && (nomeInput.dirty || nomeInput.touched) }"
      />
      <div *ngIf="nomeInput.invalid && (nomeInput.dirty || nomeInput.touched)" class="error-message">
        <small *ngIf="nomeInput.errors?.['required']">Nome do ponto √© obrigat√≥rio.</small>
        <small *ngIf="nomeInput.errors?.['minlength']">Nome do ponto deve ter no m√≠nimo 3 caracteres.</small>
        <small *ngIf="nomeInput.errors?.['pattern']">Digite apenas letras, numeros e espa√ßos.</small>
      </div>
    </div>

    <div class="form-group">
      <label for="responsavel">Respons√°vel:</label>
      <input 
        id="responsavel" 
        name="responsavel" 
        [(ngModel)]="pontoColetaAtual.responsavel" 
        type="text" 
        placeholder="Nome completo do respons√°vel"
        minlength="3"
        pattern="^[A-Za-z√Ä-√ø\s]+$"
        required
        #responsavelInput="ngModel"
        [ngClass]="{ 'invalid-input': responsavelInput.invalid && (responsavelInput.dirty || responsavelInput.touched) }"
      />
      <div *ngIf="responsavelInput.invalid && (responsavelInput.dirty || responsavelInput.touched)" class="error-message">
        <small *ngIf="responsavelInput.errors?.['required']">Respons√°vel √© obrigat√≥rio.</small>
        <small *ngIf="responsavelInput.errors?.['minlength']">Respons√°vel deve ter no m√≠nimo 3 caracteres.</small>
        <small *ngIf="responsavelInput.errors?.['pattern']">Digite apenas letras e espa√ßos.</small>
      </div>
    </div>

    <div class="form-group">
      <label for="telefoneResponsavel">Telefone do Respons√°vel:</label>
      <input 
        id="telefoneResponsavel" 
        name="telefoneResponsavel" 
        [(ngModel)]="pontoColetaAtual.telefoneResponsavel" 
        required 
        [mask]="'(00) 00000-0000'" 
        [dropSpecialCharacters]="false" 
        placeholder="(00) 00000-0000"
        required
        #telefoneInput="ngModel"
        [ngClass]="{ 'invalid-input': telefoneInput.invalid && (telefoneInput.dirty || telefoneInput.touched) }"
      />
      <div *ngIf="telefoneInput.invalid && (telefoneInput.dirty || telefoneInput.touched)" class="error-message">
        <small *ngIf="telefoneInput.errors?.['required']">Telefone √© obrigat√≥rio.</small>
      </div>
    </div>

    <div class="form-group">
      <label for="emailResponsavel">E-mail do Respons√°vel</label>
      <input
        type="email"
        id="emailResponsavel"
        name="emailResponsavel"
        [(ngModel)]="pontoColetaAtual.emailResponsavel"
        #emailInput="ngModel"
        placeholder="Ex: joaquim@gmail.com"
        required
        email
        pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
        [ngClass]="{ 'invalid-input': emailInput.invalid && (emailInput.dirty || emailInput.touched) }"
      />

      <div *ngIf="emailInput.invalid && (emailInput.dirty || emailInput.touched)" class="error-message">
        <small *ngIf="emailInput.errors?.['required']">Email √© obrigat√≥rio.</small>
        <small *ngIf="emailInput.errors?.['email']">Formato de email inv√°lido.</small>
        <small *ngIf="emailInput.errors?.['pattern']">Formato de email n√£o aceito.</small>
      </div>
    </div>

      <div class="form-group">
        <label for="endereco">Endere√ßo:</label>
        <input 
          id="endereco" 
          name="endereco" 
          [(ngModel)]="pontoColetaAtual.endereco" 
          type="text" 
          placeholder="Ex: Rua X, Qd. Y, Lt. Z, Setor W"
          required
          #enderecoInput="ngModel"
          [ngClass]="{ 'invalid-input': enderecoInput.invalid && (enderecoInput.dirty || enderecoInput.touched) }"
        />
        <div *ngIf="enderecoInput.invalid && (enderecoInput.dirty || enderecoInput.touched)" class="error-message">
          <small *ngIf="enderecoInput.errors?.['required']">Endere√ßo √© obrigat√≥rio.</small>
        </div>
      </div>

    <div class="form-group">
      <label for="horarioFuncionamento">Hor√°rio de Funcionamento:</label>
      <input 
        id="horarioFuncionamento" 
        name="horarioFuncionamento" 
        [(ngModel)]="pontoColetaAtual.horarioFuncionamento" 
        type="text"
        [mask]="'00:00 - 00:00'"
        [dropSpecialCharacters]="false" 
        placeholder="Ex: 08:00 - 18:00"
        required
        pattern="^([01][0-9]|2[0-3]):([0-5][0-9])\s-\s([01][0-9]|2[0-3]):([0-5][0-9])$"
        #horarioInput="ngModel"
        [ngClass]="{ 'invalid-input': horarioInput.invalid && (horarioInput.dirty || horarioInput.touched) }"
      />
      <div *ngIf="horarioInput.invalid && (horarioInput.dirty || horarioInput.touched)" class="error-message">
        <small *ngIf="horarioInput.errors?.['required']">Hor√°rio de funcionamento √© obrigat√≥rio.</small>
        <small *ngIf="horarioInput.errors?.['pattern']">Formato inv√°lido. Use HH:MM - HH:MM (00:00 at√© 23:59).</small>
      </div>
    </div>

    <div class="form-group">
      <label class="group-label">Tipos de Res√≠duos Aceitos:</label>

      <div class="checkbox-group">
        <div *ngFor="let tipo of opcoesTiposResiduos" class="checkbox-item">
          <input 
            type="checkbox"
            [id]="'tipo-' + tipo"
            [name]="'tipo-' + tipo"
            [value]="tipo"
            [(ngModel)]="tiposResiduosSelecionados[tipo]"
            (ngModelChange)="onTipoResiduoChange(tipo, $event)"
          />
          <label [for]="'tipo-' + tipo" class="checkbox-label">{{ tipo }}</label>
        </div>
      </div>
      <div *ngIf="nenhumResiduoSelecionado()" class="error-message">
        <small>Selecione pelo menos um tipo de res√≠duo.</small>
      </div>
    </div>

  <div *ngIf="mensagem?.tipo" [ngClass]="['popup', mensagem.tipo === 'erro' ? 'error' : 'success']">
    <span *ngIf="mensagem.tipo === 'salvo'">‚úÖ</span>
    <span *ngIf="mensagem.tipo === 'editado'">‚úèÔ∏è</span>
    <span *ngIf="mensagem.tipo === 'excluido'">üóëÔ∏è</span>
    <span *ngIf="mensagem.tipo === 'erro'">‚ùå</span>
    {{ mensagem.texto }}
  </div>

    <div class="button-group">
      <button type="submit" class="btn salvar" [disabled]="formPontoColeta.invalid || nenhumResiduoSelecionado()">
        üíæ {{ idEditando ? 'Atualizar' : 'Salvar' }}
      </button>
      <button
        type="button"
        *ngIf="idEditando"
        class="btn cancelar"
        (click)="resetForm(formPontoColeta)"
      >
        ‚ùå Cancelar Edi√ß√£o
      </button>
    </div>

  </form>
</div>

<hr />

<header>
  <h3>Pontos de Coleta Cadastrados:</h3>
</header>

<table class="tabela-dados">
  <thead>
    <tr>
      <th>Bairro</th>
      <th>Nome</th>
      <th>Respons√°vel</th>
      <th>Telefone</th>
      <th>Email</th>
      <th>Endere√ßo</th>
      <th>Funcionamento</th>
      <th>Tipos Res√≠duos</th>
      <th>A√ß√µes</th>
    </tr>
  </thead>
  <tbody>
    <tr *ngFor="let pontoColeta of pontosColeta">
      <td>{{ pontoColeta.bairro.nome}}</td>
      <td>{{ pontoColeta.nome }}</td>
      <td>{{ pontoColeta.responsavel }}</td>
      <td>{{ pontoColeta.telefoneResponsavel }}</td>
      <td>{{ pontoColeta.emailResponsavel }}</td>
      <td>{{ pontoColeta.endereco }}</td>
      <td>{{ pontoColeta.horarioFuncionamento }}</td>
      <td>{{ pontoColeta.tiposResiduosAceitos.join(', ') }}</td>
      <td>
        <button class="btn editar" (click)="editar(pontoColeta)">‚úèÔ∏è Editar</button>
        <button class="btn excluir" (click)="excluir(pontoColeta.id!)">üóëÔ∏è Excluir</button>
      </td>
    </tr>
    <tr *ngIf="pontosColeta.length === 0">
      <td colspan="9" style="text-align: center;">Nenhum Ponto de Coleta cadastrado.</td>
    </tr>
  </tbody>
</table>
